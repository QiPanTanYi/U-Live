<style>
.page {
	position: absolute;
	left: 0;
	right: 0;
	top: 0;
	bottom: 0;
	background-color: #181b27;
	
	display: flex;
	flex-direction: column;
	justify-content: flex-start;
}

.line {
	height: 1rpx;
	background-color: #393a41;
	width: 750rpx;
}

.single-line-box {
	display: flex;
	flex-direction: row;
	justify-content: flex-start;
	
	padding: 30rpx;
	margin-top: 20rpx;
}
.uliveNum-input {
	padding-left: 10px;
	color: #FFFFFF;
	font-size: 14px;
	width: 600rpx;
	height: 50px;
	background-color: #4a4c52;
	border-top-left-radius: 10px;
	border-bottom-left-radius: 10px;
}
.length-cal {
	width: 100rpx;
	height: 50px;
	background-color: #4a4c52;
	padding-right: 10px;
	display: flex;
	flex-direction: column;
	justify-content: flex-end;
	padding-bottom: 12rpx;
	border-top-right-radius: 10px;
	border-bottom-right-radius: 10px;
}
.length-text {
	font-size: 12px;
	font-weight: 400;
	color: #F1F1F1;
}
.tips {
	font-size: 12px;
	font-weight: 400;
	color: #BFBFBF;
	width: 700rpx;
}
.tips-limit {
	font-size: 13px;
	font-weight: 500;
	color: #AFAFB3;
	width: 750rpx;
	padding-left: 30rpx;
}
.limit-wrapper {
	background-color: #333030;
	height: 60rpx;
	display: flex;
	flex-direction: column;
	justify-content: center;
}
</style>
<template>
	<view class="page">
		<!-- <view class="line"></view> -->
		
		<view class="limit-wrapper" v-if="!canIModify" style="align-self: center; ">
			<text class="tips-limit">ğŸ‘‰ğŸ» ä¿®æ”¹æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼</text> 
		</view>
		
		<view class="single-line-box" style="align-self: center;">
			
			<input 
				class="uliveNum-input"
				type="text" 
				:value="uliveNum" 
				:model="uliveNum" 
				placeholder="è¯·å¡«å…¥ä½ çš„æ¸¸Liveå·~"
				maxlength="12"
				:disabled="!canIModify"
				@input="typingContent"/>
			
			<view class="length-cal">
				<text class="length-text">{{wordsLength}}/12</text> 
			</view>
			
		</view>
		
		<view class="" style="align-self: center;">
			<text class="tips">*æ³¨ï¼šè¯·è®¾ç½®6-12çš„æ¸¸Liveå·é•¿åº¦ã€‚æ¸¸Liveå·åªèƒ½ä¿®æ”¹ä¸€æ¬¡å™¢~ï¼ï¼ï¼</text> 
		</view>
		
	</view>
</template>

<script>
	var app = getApp();
	export default {
		data() {
			return {
				oldUliveNum: getApp().getUserInfoSession().uliveNum,
				uliveNum: getApp().getUserInfoSession().uliveNum,
				wordsLength: 0,
				canIModify: false,		// ç”¨äºåˆ¤æ–­æ˜¯å¦å¯ä»¥ä¿®æ”¹Uliveå·ï¼Œæ¯ä¸ªäººä»…é™ä¿®æ”¹ä¸€æ¬¡ï¼ˆä¸€èˆ¬å¯ä»¥ç”¨äºæ”¶è´¹äºŒæ¬¡ä¿®æ”¹ï¼Œæˆ–è€…1å¹´å…è´¹1æ¬¡ï¼‰
			}
		},
		onNavigationBarButtonTap() {
			var uliveNum = this.uliveNum;
			if (uliveNum.length > 12 || uliveNum.length < 6) {
				uni.showToast({
					icon: "none",
					title: "æ¸¸Liveå·é•¿åº¦ä¸º6-12"
				})
				return;
			}
			
			var oldUliveNum = this.oldUliveNum;
			if (oldUliveNum == uliveNum) {
				uni.showToast({
					icon: "none",
					title: "æ¸¸Liveå·ç›¸åŒ"
				})
				return;
			}
			
			var canIModify = this.canIModify;
			if (canIModify == false) {
				uni.showToast({
					icon: "none",
					title: "ä¿®æ”¹æ¬¡æ•°å·²è¾¾ä¸Šé™"
				})
				return;
			}
			
			this.updateUliveNum();
		},
		onLoad() {
			var canIModify = getApp().getUserInfoSession().canUliveNumBeUpdated == 1;
			this.canIModify = canIModify;
			
			// å¯¼èˆªæ æŒ‰é’®éšè—
			if(!canIModify) {
				let pages = getCurrentPages()
				let page = pages[pages.length - 1];
				let currentWebview = page.$getAppWebview();
				currentWebview.setTitleNViewButtonStyle(0, {
					text: "0",
					width: 0
				});
			}
		},
		onShow() {
			this.wordsLength = this.uliveNum.length;
		},
		methods: {
			updateUliveNum() {
				var me = this;
				var userId = getApp().getUserInfoSession().id;
				var uliveNum = this.uliveNum;
				
				// åç«¯è¿˜æ˜¯éœ€è¦æ ¡éªŒèƒ½å¦ä¿®æ”¹ï¼Œå› ä¸ºç”¨æˆ·å¯ä»¥ç»•è¿‡å‰ç«¯ç›´æ¥è¯·æ±‚åç«¯æ¥å£
				var pendingUserInfo = {
					"id": userId,
					"uliveNum": uliveNum
				};
				
				// ä¿®æ”¹æ¸¸Liveå·
				var serverUrl = app.globalData.serverUrl;
				uni.request({
					method: "POST",
					header: {
						headerUserId: userId,
						headerUserToken: app.getUserSessionToken()
					},
					url: serverUrl + "/userInfo/modifyUserInfo?type=2",
					data: pendingUserInfo,
					success(result) {
						
						if (result.data.status == 200) {
							var userInfoUpdated = result.data.data;
							// é‡ç½®æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
							app.setUserInfoSession(userInfoUpdated);
							
							uni.navigateBack({
								delta: 1,
								animationType: "fade-out"
							})
						} else {
							uni.showToast({
								title: result.data.msg,
								icon: "none",
								duration: 3000
							});
						}
						
					}
				})
			},
			
			typingContent(e) {
				var event = e;
				this.uliveNum = e.detail.value;
				this.wordsLength = this.uliveNum.length;
			},
		}
	}
</script>

